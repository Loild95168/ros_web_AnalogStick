let lastEmitTime = 0;
const throttleInterval = 100;
const maxSpeed = 2.0;

let lastLinear = 0.0;
let lastAngular = 0.0;
let joystickActive = false;

manager.on('move', function(evt, data) {
  const now = Date.now();
  if (now - lastEmitTime < throttleInterval) return;
  lastEmitTime = now;

  const angle = data.angle.radian;
  const distance = data.distance;
  const speedFactor = Math.min(distance / 100, 1.0);

  lastLinear = Math.sin(angle) * maxSpeed * speedFactor;
  lastAngular = -Math.cos(angle) * maxSpeed * speedFactor;
  joystickActive = true;

  sendAnalogControl();
});

manager.on("end", () => {
  lastLinear = 0.0;
  lastAngular = 0.0;
  joystickActive = false;
  sendAnalogControl();
  status.innerText = "ðŸ›‘ åœæ­¢";
});

function sendAnalogControl() {
  socket.emit("analog_control", {
    linear: lastLinear.toFixed(2),
    angular: lastAngular.toFixed(2),
    client_time: new Date().toISOString()
  });

  status.innerText = `ðŸš€ å‰é€²=${lastLinear.toFixed(2)} æ—‹è½‰=${lastAngular.toFixed(2)}`;
}

// ðŸ” æ¯ 100ms å®šæ™‚é‡é€ä¸€æ¬¡æŽ§åˆ¶è¨Šè™Ÿ
setInterval(() => {
  if (joystickActive) {
    sendAnalogControl();
  }
}, 100);
