<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å°çƒé¾œé›™æ–æ¡¿æ§åˆ¶</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
      margin-top: 40px;
    }
    #joystickWrapper {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    .joystickColumn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      min-width: 240px;
    }
    .joystickZone {
      width: 260px;
      height: 260px;
      background: radial-gradient(circle at 30% 30%, #f8f8f8, #d7d7d7);
      border-radius: 50%;
      position: relative;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .joystickLabel {
      font-weight: bold;
      font-size: 1.1rem;
    }
    .joystickHint {
      color: #666;
      font-size: 0.9rem;
    }
    #readout {
      margin-top: 12px;
      font-size: 1.1rem;
    }
    #status {
      margin-top: 30px;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <h2>ğŸ¢ å°çƒé¾œé›™æ–æ¡¿æ§åˆ¶</h2>
  <div id="joystickWrapper">
    <div class="joystickColumn">
      <div id="linearJoystick" class="joystickZone"></div>
      <div class="joystickLabel">ç·šé€Ÿåº¦ (x)</div>
      <div class="joystickHint">ä¸Š/ä¸‹ï¼šå‰é€²/å¾Œé€€</div>
    </div>
    <div class="joystickColumn">
      <div id="angularJoystick" class="joystickZone"></div>
      <div class="joystickLabel">è§’é€Ÿåº¦ (z)</div>
      <div class="joystickHint">å·¦/å³ï¼šé †æ™‚é‡/é€†æ™‚é‡</div>
    </div>
  </div>
  <p id="status">ç­‰å¾…æ“ä½œ</p>
  <div id="readout">
    <span id="linearReadout">ç·šé€Ÿåº¦ï¼š0.00</span>
    <span id="angularReadout" style="margin-left: 16px;">è§’é€Ÿåº¦ï¼š0.00</span>
  </div>

  <script>
    const socket = io();
    const linearZone = document.getElementById("linearJoystick");
    const angularZone = document.getElementById("angularJoystick");
    const status = document.getElementById("status");
    const linearReadout = document.getElementById("linearReadout");
    const angularReadout = document.getElementById("angularReadout");

    const joystickOptions = {
      mode: "static",
      position: { left: "50%", top: "50%" },
      color: "blue",
      size: 180
    };

    const linearManager = nipplejs.create(Object.assign({ zone: linearZone }, joystickOptions));
    const angularManager = nipplejs.create(Object.assign({ zone: angularZone }, joystickOptions));

    let lastEmitTime = 0;
    const throttleInterval = 100;
    const maxSpeed = 2.0;

    let lastLinear = 0.0;
    let lastAngular = 0.0;
    let linearActive = false;
    let angularActive = false;

    function updateStatus() {
      status.innerText = `ğŸš€ å‰é€²=${lastLinear.toFixed(2)} æ—‹è½‰=${lastAngular.toFixed(2)}`;
      linearReadout.innerText = `ç·šé€Ÿåº¦ï¼š${lastLinear.toFixed(2)}`;
      angularReadout.innerText = `è§’é€Ÿåº¦ï¼š${lastAngular.toFixed(2)}`;
    }

    function sendAnalogControl(force = false) {
      const now = Date.now();
      if (!force && now - lastEmitTime < throttleInterval) return;
      lastEmitTime = now;

      socket.emit("analog_control", {
        linear: lastLinear.toFixed(2),
        angular: lastAngular.toFixed(2),
        client_time: new Date().toISOString()
      });

      updateStatus();
    }

    function handleMove(type, data) {
      const angle = data.angle.radian;
      const distance = data.distance;
      const speedFactor = Math.min(distance / 100, 1.0);

      if (type === "linear") {
        lastLinear = Math.sin(angle) * maxSpeed * speedFactor;
        linearActive = true;
      } else {
        lastAngular = -Math.cos(angle) * maxSpeed * speedFactor;
        angularActive = true;
      }

      sendAnalogControl();
    }

    function handleEnd(type) {
      if (type === "linear") {
        lastLinear = 0.0;
        linearActive = false;
      } else {
        lastAngular = 0.0;
        angularActive = false;
      }

      sendAnalogControl(true);

      if (!linearActive && !angularActive) {
        status.innerText = "ğŸ›‘ åœæ­¢";
      }
    }

    linearManager.on("move", (evt, data) => handleMove("linear", data));
    angularManager.on("move", (evt, data) => handleMove("angular", data));

    linearManager.on("end", () => handleEnd("linear"));
    angularManager.on("end", () => handleEnd("angular"));

    setInterval(() => {
      if (linearActive || angularActive) {
        sendAnalogControl(true);
      }
    }, 100);
  </script>
</body>
</html>
