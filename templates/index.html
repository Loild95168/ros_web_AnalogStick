<script>
  const socket = io();
  const zone = document.getElementById("joystickZone");
  const status = document.getElementById("status");

  const manager = nipplejs.create({
    zone: zone,
    mode: "static",
    position: { left: "50%", top: "50%" },
    color: "blue"
  });

  let lastEmitTime = 0;
  const throttleInterval = 100; // 每 100ms 傳一次

  const maxSpeed = 2.0;

  manager.on('move', function(evt, data) {
    const now = Date.now();
    if (now - lastEmitTime < throttleInterval) return;
    lastEmitTime = now;

    const angle = data.angle.radian;
    const distance = data.distance;
    const speedFactor = Math.min(distance / 100, 1.0);

    // ✅ 類比搖桿邏輯修正
    const linear_x = Math.sin(angle) * maxSpeed * speedFactor;
    const angular_z = -Math.cos(angle) * maxSpeed * speedFactor;

    socket.emit("analog_control", {
      linear: linear_x.toFixed(2),
      angular: angular_z.toFixed(2),
      client_time: new Date().toISOString()
    });

    status.innerText = `速度：x=${linear_x.toFixed(2)}, z=${angular_z.toFixed(2)}`;
  });

  manager.on("end", () => {
    socket.emit("analog_control", {
      linear: 0.0,
      angular: 0.0,
      client_time: new Date().toISOString()
    });
    status.innerText = "控制：停止";
  });
</script>
